<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantry-Pal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/64/12493/12493626.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        @keyframes pulse-bg {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .animate-pulse-bg {
            background: linear-gradient(to right, #f0f0f0 0%, #e0e0e0 20%, #f0f0f0 40%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: pulse-bg 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }

        /* Specific pulse background for the send button when loading */
        .send-button-pulse {
            background: linear-gradient(to right, #d1d5db 0%, #a1a1aa 20%, #d1d5db 40%, #d1d5db 100%); /* Gray shades for the pulse */
            background-size: 200% 100%;
            animation: pulse-bg 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }

        /* Keyframes for bounce/wiggle animation */
        @keyframes bounce-wiggle {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-2px) translateY(-2px); }
            50% { transform: translateX(2px) translateY(2px); }
            75% { transform: translateX(-2px) translateY(-2px); }
        }

        .animate-bounce-wiggle {
            animation: bounce-wiggle 0.3s ease-in-out;
        }

        /* Category selection pulse/glow */
        @keyframes category-pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } /* Indigo-500 equivalent */
            70% { box-shadow: 0 0 0 8px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .category-selected-glow {
            animation: category-pulse 1s ease-out;
        }

        /* Checkmark for selected category */
        .category-selected-checkmark::after {
            content: '✓'; /* Unicode checkmark */
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.8em;
            color: white;
            background-color: #4CAF50; /* Green */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            line-height: 1; /* Adjust line-height to center the checkmark vertically */
        }

        /* Custom scrollbar for Notion items display */
        #notion-items-display::-webkit-scrollbar {
            width: 8px; /* width of the scrollbar */
        }

        #notion-items-display::-webkit-scrollbar-track {
            background: #f1f1f1; /* color of the track */
            border-radius: 10px;
        }

        #notion-items-display::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* color of the scroll thumb (slate-300) */
            border-radius: 10px;
        }

        #notion-items-display::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* color when hovering over thumb (slate-400) */
        }

        /* Category icon bounce animation */
        @keyframes category-icon-bounce {
            0%, 100% { transform: translateY(0) scale(1.25); }
            50% { transform: translateY(-3px) scale(1.3); } /* Slightly larger bounce */
        }
        .category-selected-glow img {
            animation: category-icon-bounce 0.3s ease-out; /* Apply to the image within the selected button */
        }

    </style>
</head>
<body class="font-['Outfit'] bg-gradient-to-br from-purple-100 via-rose-100 to-amber-100 flex items-center justify-center min-h-screen p-4">

    <svg style="display:none;">
        <symbol id="icon-flame" viewBox="0 0 24 24">
            <path d="M12 2C7 2 4 4 4 11c0 5.5 5 11 8 11s8-5.5 8-11c0-7-3-9-8-9zm0 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/>
        </symbol>
    </svg>

    <div class="w-full max-w-sm mx-auto bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 space-y-2">
        
        <div class="text-center">
            <div class="flex items-center justify-center mx-auto mb-2">
                <img src="https://cdn-icons-png.flaticon.com/512/2515/2515263.png" alt="Pantry-Pal Logo" class="w-16 h-16 mr-2">
                <h1 class="text-2xl font-bold text-gray-800">Pantry-Pal</h1>
            </div>
            <p class="text-gray-500 mt-1">What did we have today? ✨</p>
        </div>

        <div class="flex border-b-2 border-gray-300 -mx-6 px-6 pt-2">
            <button id="tab-category" class="flex-1 py-2 px-3 text-center text-base font-bold rounded-t-xl cursor-pointer transition-colors duration-200 bg-indigo-500 text-white shadow-md">Add</button>
            <button id="tab-today" class="flex-1 py-2 px-3 text-center text-base font-bold rounded-t-xl cursor-pointer transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Today</button>
        </div>

        <div class="pt-4 mt-4 border-t border-gray-200">
            <div id="kcal-progress-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1500" class="w-full bg-gray-200 rounded-full h-3 relative overflow-hidden">
                <div id="kcal-progress-fill" class="h-full bg-green-500 transition-all duration-500 ease-in-out" style="width: 0%;"></div>
            </div>
            <p id="kcal-progress-text" class="text-sm font-semibold text-gray-700 text-center mt-2">0 / 1500 kcal</p>
        </div>
        <div id="section-category" class="space-y-2 mt-4">
            <div>
                <div id="category-container" class="grid grid-cols-3 gap-3 mt-2">
                    <button class="relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-sky-200 bg-sky-100 text-sky-800 hover:border-sky-400" data-category="Breakfast">
                        <img src="https://cdn-icons-png.flaticon.com/128/9702/9702245.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Breakfast</span>
                    </button>
                    <button class="relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-violet-200 bg-violet-100 text-violet-800 hover:border-violet-400" data-category="Collagen">
                        <img src="https://cdn-icons-png.flaticon.com/128/11210/11210895.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Collagen</span>
                    </button>
                    <button class="relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-amber-200 bg-amber-100 text-amber-800 hover:border-amber-400" data-category="Coffee">
                        <img src="https://cdn-icons-png.flaticon.com/128/1448/1448438.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Coffee</span>
                    </button>
                    <button class="relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-lime-200 bg-lime-100 text-lime-800 hover:border-lime-400" data-category="Lunch">
                        <img src="https://cdn-icons-png.flaticon.com/128/2515/2515271.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Lunch</span>
                    </button>
                    <button class="relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-teal-200 bg-teal-100 text-teal-800 hover:border-teal-400" data-category="Exercise">
                        <img src="https://cdn-icons-png.flaticon.com/128/7681/7681038.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Exercise</span>
                    </button>
                    <button class="relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-slate-200 bg-slate-100 text-slate-800 hover:border-slate-400" data-category="Other">
                        <img src="https://cdn-icons-png.flaticon.com/128/7245/7245102.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Other</span>
                    </button>
                    </button>
                </div>
                <input type="hidden" id="selected-category" name="category">
            </div>

            <div class="space-y-2">
                <div>
                    <label for="description" class="sr-only">Description</label>
                    <input type="text" id="description" name="description" placeholder="Description (e.g., Avocado toast)" class="mt-1.5 p-3 block w-full border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 bg-white/70 shadow-sm">
                </div>
                <div>
                    <label for="kcal" class="sr-only">Kcal</label>
                    <input type="number" id="kcal" name="kcal" placeholder="kcal (e.g., 350)" class="mt-1.5 p-3 block w-full border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 bg-white/70 shadow-sm">
                </div>
            </div>
            
            <button id="send-btn" class="w-full flex items-center justify-center p-3 bg-rose-500 text-white text-lg font-bold rounded-xl shadow-md transition-all duration-200 ease-in-out transform scale-100 hover:bg-rose-600 active:bg-rose-700 active:scale-100">
                <span id="send-btn-content" class="flex items-center justify-center">
                    Log My Meal!
                    <img src="https://cdn-icons-png.flaticon.com/128/1788/1788911.png" alt="Flame Icon" class="w-6 h-6 ml-2 animate-bounce-wiggle">
                </span>
                <span id="send-btn-loading-text" class="hidden">Processing...</span>
            </button>
            
            <div id="message-area" class="text-center font-medium"></div>

        </div>

        <div id="section-today" class="space-y-2 mt-4 hidden">
            <div id="notion-items-display" class="bg-gray-50 p-4 rounded-lg shadow-inner max-h-80 overflow-y-auto space-y-2 text-lg text-gray-700 mt-2">
                </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const categoryContainer = document.getElementById('category-container');
            const hiddenCategoryInput = document.getElementById('selected-category');
            const descriptionInput = document.getElementById('description');
            const kcalInput = document.getElementById('kcal'); 
            const sendBtn = document.getElementById('send-btn');
            const messageArea = document.getElementById('message-area');

            // Elements for button loading state
            const sendBtnContent = document.getElementById('send-btn-content');
            const sendBtnLoadingText = document.getElementById('send-btn-loading-text');

            const notionItemsDisplay = document.getElementById('notion-items-display');

            // Kcal Progress Bar Elements
            const kcalProgressBarContainer = document.getElementById('kcal-progress-bar-container');
            const kcalProgressFill = document.getElementById('kcal-progress-fill');
            const kcalProgressText = document.getElementById('kcal-progress-text');
            const KCAL_CAP = 1500; // Define the Kcal cap

            // Tab Elements
            const tabCategoryBtn = document.getElementById('tab-category');
            const tabTodayBtn = document.getElementById('tab-today');
            const sectionCategory = document.getElementById('section-category');
            const sectionToday = document.getElementById('section-today');

            // --- NOTION API ENDPOINT CONFIGURATION ---
            const NOTION_BACKEND_URL = 'https://pantrypal-gilt.vercel.app/api/pantryapi';
            // const NOTION_BACKEND_URL = '/api/pantryapi'; // Local deployment

            // Define placeholder values for each category
            const kcalPlaceholders = {
                "Coffee": "50",
                "Breakfast": "311",
                "Lunch": "800",
                "Collagen": "40",
                "Exercise": "300" 
            };

            // --- Dynamic Description Placeholders ---
            const descriptionPlaceholders = {
                "Breakfast": [
                    "Avocado toast with egg",
                    "Oatmeal with berries",
                    "Scrambled eggs and bacon",
                    "Yogurt parfait",
                    "Pancakes with syrup",
                    "Smoothie bowl",
                    "Fruit and muesli"
                ],
                "Collagen": [
                    "Collagen in water",
                    "Collagen in coffee",
                    "Collagen smoothie",
                    "Collagen with juice",
                    "Collagen mixed into yogurt"
                ],
                "Coffee": [
                    "Black coffee",
                    "Latte with oat milk",
                    "Espresso shot",
                    "Cappuccino",
                    "Iced Americano",
                    "Flat white",
                    "Mocha"
                ],
                "Lunch": [
                    "Chicken salad",
                    "Pasta with pesto",
                    "Vegetable stir-fry",
                    "Sandwich with turkey",
                    "Sushi rolls",
                    "Quinoa salad",
                    "Lentil soup"
                ],
                "Exercise": [
                    "30 min run",
                    "Weightlifting session (legs)",
                    "Yoga flow (60 min)",
                    "Cycling (1 hour)",
                    "Swimming laps (30 min)",
                    "HIIT workout",
                    "Boxing training"
                ],
                "Other": [
                    "Snack (e.g., Apple)",
                    "Dessert (e.g., Chocolate)",
                    "Random drink (e.g., Soda)",
                    "Supplement intake (e.g., Vitamin D)",
                    "Midnight snack",
                    "Something sweet"
                ]
            };

            // Helper function to get a random item from an array
            function getRandomItem(arr) {
                if (!arr || arr.length === 0) return "";
                const randomIndex = Math.floor(Math.random() * arr.length);
                return arr[randomIndex];
            }

            // Function to set description placeholder based on category
            function updateDescriptionPlaceholder(category) {
                const randomText = getRandomItem(descriptionPlaceholders[category] || descriptionPlaceholders["Other"]);
                descriptionInput.placeholder = `Description (e.g., ${randomText})`;
            }


            // --- Tab Switching Logic ---
            const tabBaseClasses = ['flex-1', 'py-2', 'px-3', 'text-center', 'text-base', 'font-bold', 'rounded-t-xl', 'cursor-pointer', 'transition-colors', 'duration-200'];
            const tabDefaultClasses = ['bg-gray-200', 'text-gray-700', 'hover:bg-gray-300'];
            const tabActiveClass = ['bg-indigo-500', 'text-white', 'shadow-md'];

            function setTabActiveState(button, isActive) {
                button.classList.remove(...tabDefaultClasses, ...tabActiveClass);
                if (isActive) {
                    button.classList.add(...tabActiveClass);
                } else {
                    button.classList.add(...tabDefaultClasses);
                }
            }

            function showTab(tabName) {
                setTabActiveState(tabCategoryBtn, false);
                setTabActiveState(tabTodayBtn, false);

                sectionCategory.classList.add('hidden');
                sectionToday.classList.add('hidden');

                if (tabName === 'category') {
                    setTabActiveState(tabCategoryBtn, true);
                    sectionCategory.classList.remove('hidden');
                } else if (tabName === 'today') {
                    setTabActiveState(tabTodayBtn, true);
                    sectionToday.classList.remove('hidden');
                    loadNotionItems(); // Always load/reload items when switching tabs
                }
            }

            // --- Logic for Category Selection ---
            const categorySelectedClasses = [
                'border-indigo-500', 
                'bg-gradient-to-br', 'from-indigo-300', 'to-indigo-400', /* Gradient for selection */
                'text-white', 
                'scale-105', 
                'shadow-lg', 
                'category-selected-glow', 
                'category-selected-checkmark'
            ];
            const categoryDefaultImgClasses = ['transition-transform', 'duration-600', 'ease-in'];

            categoryContainer.addEventListener('click', function(e) {
                const clickedButton = e.target.closest('button');
                if (!clickedButton || !clickedButton.dataset.category) return;

                const allButtons = categoryContainer.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.classList.remove(...categorySelectedClasses);
                    // Revert to original background and text colors if not selected
                    const categoryData = btn.dataset.category;
                    const defaultColorClasses = {
                        "Breakfast": "border-sky-200 bg-sky-100 text-sky-800 hover:border-sky-400",
                        "Collagen": "border-violet-200 bg-violet-100 text-violet-800 hover:border-violet-400",
                        "Coffee": "border-amber-200 bg-amber-100 text-amber-800 hover:border-amber-400",
                        "Lunch": "border-lime-200 bg-lime-100 text-lime-800 hover:border-lime-400",
                        "Exercise": "border-teal-200 bg-teal-100 text-teal-800 hover:border-teal-400",
                        "Other": "border-slate-200 bg-slate-100 text-slate-800 hover:border-slate-400",
                    };
                    // Clear previous specific classes and apply defaults
                    btn.className = `relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out ${defaultColorClasses[categoryData]}`;

                    const img = btn.querySelector('img');
                    if (img) {
                        img.classList.remove('scale-125', 'ease-out');
                        img.classList.add('ease-in');
                    }
                });

                // Apply selected classes, including the gradient and white text
                clickedButton.classList.add(...categorySelectedClasses);
                const clickedImg = clickedButton.querySelector('img');
                if (clickedImg) {
                    clickedImg.classList.add('scale-125', 'ease-out');
                    clickedImg.classList.remove('ease-in');
                }
                
                const selectedCategory = clickedButton.dataset.category; 
                hiddenCategoryInput.value = selectedCategory; 

                // --- Update Kcal placeholder based on selected category ---
                if (kcalPlaceholders[selectedCategory]) {
                    const placeholderValue = (selectedCategory === "Exercise") ? -Math.abs(parseInt(kcalPlaceholders[selectedCategory] || 0)) : kcalPlaceholders[selectedCategory];
                    kcalInput.placeholder = `kcal (e.g., ${placeholderValue})`;
                } else {
                    kcalInput.placeholder = "kcal (e.g., 350)"; 
                }

                if (selectedCategory === "Exercise" && kcalInput.value !== "") {
                     kcalInput.value = -Math.abs(parseInt(kcalInput.value || 0));
                } else if (selectedCategory !== "Exercise" && kcalInput.value !== "" && parseInt(kcalInput.value) < 0) {
                     kcalInput.value = Math.abs(parseInt(kcalInput.value));
                }
                
                // --- Update Description placeholder dynamically ---
                updateDescriptionPlaceholder(selectedCategory);
                descriptionInput.focus(); 
            });

            // Listen for changes in the Kcal input to ensure 'Exercise' values stay negative
            kcalInput.addEventListener('input', function() {
                const selectedCategory = hiddenCategoryInput.value;
                if (selectedCategory === "Exercise" && parseInt(this.value) > 0) {
                    this.value = -Math.abs(parseInt(this.value));
                } else if (selectedCategory !== "Exercise" && parseInt(this.value) < 0) {
                    this.value = Math.abs(parseInt(this.value));
                }
            });

            // --- "Enter" key submission logic ---
            descriptionInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    sendBtn.click();
                }
            });
            kcalInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendBtn.click();
                }
            });


            // --- Function to send data to Notion via backend (POST request) ---
            async function sendToNotion(data) {
                messageArea.textContent = ''; 
                sendBtn.disabled = true; 
                sendBtnContent.classList.add('hidden'); 
                sendBtnLoadingText.classList.remove('hidden'); 

                sendBtn.classList.remove('bg-rose-500', 'text-white', 'hover:bg-rose-600', 'active:bg-rose-700', 'shadow-md');
                sendBtn.classList.add('bg-gray-400', 'text-gray-600', 'send-button-pulse', 'cursor-not-allowed');

                try {
                    const response = await fetch(NOTION_BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Backend (POST) error:', errorData);
                        throw new Error(`Error: ${errorData.message || errorData.error || 'Unknown backend error'}`);
                    }

                    const result = await response.json();
                    console.log('Successfully sent to Notion via backend:', result);
                    
                    // Immediately clear inputs on success
                    hiddenCategoryInput.value = '';
                    descriptionInput.value = '';
                    kcalInput.value = ''; 
                    kcalInput.placeholder = "kcal (e.g., 350)"; 
                    
                    // Reset description placeholder after clearing inputs (e.g., to a default random breakfast)
                    updateDescriptionPlaceholder("Breakfast"); 

                    const allButtons = categoryContainer.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        btn.classList.remove(...categorySelectedClasses);
                        const categoryData = btn.dataset.category;
                        const defaultColorClasses = {
                            "Breakfast": "border-sky-200 bg-sky-100 text-sky-800 hover:border-sky-400",
                            "Collagen": "border-violet-200 bg-violet-100 text-violet-800 hover:border-violet-400",
                            "Coffee": "border-amber-200 bg-amber-100 text-amber-800 hover:border-amber-400",
                            "Lunch": "border-lime-200 bg-lime-100 text-lime-800 hover:border-lime-400",
                            "Exercise": "border-teal-200 bg-teal-100 text-teal-800 hover:border-teal-400",
                            "Other": "border-slate-200 bg-slate-100 text-slate-800 hover:border-slate-400",
                        };
                        btn.className = `relative border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out ${defaultColorClasses[categoryData]}`;
                        const img = btn.querySelector('img');
                        if (img) {
                            img.classList.remove('scale-125', 'ease-out');
                            img.classList.add('ease-in'); 
                        }
                    });

                    if (navigator.vibrate) {
                        navigator.vibrate(50); 
                    }

                    loadNotionItems(); 
                } catch (error) {
                    console.error('Failed to send to Notion:', error);
                    messageArea.textContent = `Error: ${error.message || 'Network error'}`;
                    messageArea.style.color = '#dc2626'; 
                } finally {
                    setTimeout(() => {
                        messageArea.textContent = ''; 
                        sendBtn.disabled = false;
                        sendBtnContent.classList.remove('hidden');
                        sendBtnLoadingText.classList.add('hidden');
                        sendBtn.classList.remove('bg-gray-400', 'text-gray-600', 'send-button-pulse', 'cursor-not-allowed');
                        sendBtn.classList.add('bg-rose-500', 'text-white', 'hover:bg-rose-600', 'active:bg-rose-700', 'shadow-md');
                    }, 2000);
                }
            }

            function getSkeletonLoaderHtml(count = 3) {
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="h-6 bg-gray-200 rounded w-full mb-2 animate-pulse-bg"></div>
                    `;
                }
                return html;
            }

            let lastPercentage = 0; 
            function updateKcalProgressBar(currentKcalSum) {
                const newPercentage = Math.min(100, (currentKcalSum / KCAL_CAP) * 100);
                
                kcalProgressFill.style.width = `${newPercentage}%`;
                
                let emoji = '';
                const remaining = KCAL_CAP - currentKcalSum;

                if (currentKcalSum <= KCAL_CAP) {
                    emoji = '✨ '; 
                    kcalProgressText.textContent = `${emoji}${currentKcalSum} / ${KCAL_CAP} kcal (${remaining})`;
                } else {
                    emoji = '⚠️ '; 
                    kcalProgressText.textContent = `${emoji}${currentKcalSum} / ${KCAL_CAP} kcal (${Math.abs(remaining)} kcal Over)`;
                }

                if (currentKcalSum > KCAL_CAP) {
                    kcalProgressFill.classList.remove('bg-green-500', 'bg-yellow-500');
                    kcalProgressFill.classList.add('bg-red-500', 'bg-gradient-to-r', 'from-red-400', 'to-red-600');
                    kcalProgressText.classList.remove('text-gray-700', 'text-amber-600');
                    kcalProgressText.classList.add('text-red-600');
                } else if (newPercentage >= 80) { 
                    kcalProgressFill.classList.remove('bg-green-500', 'bg-red-500');
                    kcalProgressFill.classList.add('bg-yellow-500', 'bg-gradient-to-r', 'from-amber-400', 'to-amber-600'); 
                    kcalProgressText.classList.remove('text-gray-700', 'text-red-600');
                    kcalProgressText.classList.add('text-amber-600');
                } else {
                    kcalProgressFill.classList.remove('bg-red-500', 'bg-yellow-500', 'from-red-400', 'to-red-600', 'from-amber-400', 'to-amber-600');
                    kcalProgressFill.classList.add('bg-green-500', 'bg-gradient-to-r', 'from-green-400', 'to-green-600'); 
                    kcalProgressText.classList.remove('text-red-600', 'text-amber-600');
                    kcalProgressText.classList.add('text-gray-700');
                }

                if ((lastPercentage < 50 && newPercentage >= 50) ||
                    (lastPercentage < 80 && newPercentage >= 80) ||
                    (lastPercentage < 100 && newPercentage >= 100) ||
                    (lastPercentage <= 100 && newPercentage > 100)) { 
                    kcalProgressBarContainer.classList.add('animate-bounce-wiggle');
                    kcalProgressText.classList.add('animate-bounce-wiggle');
                    setTimeout(() => {
                        kcalProgressBarContainer.classList.remove('animate-bounce-wiggle');
                        kcalProgressText.classList.remove('animate-bounce-wiggle');
                    }, 300); 
                }
                lastPercentage = newPercentage; 

                kcalProgressBarContainer.setAttribute('aria-valuenow', currentKcalSum);
                kcalProgressBarContainer.setAttribute('aria-valuetext', `${currentKcalSum} out of ${KCAL_CAP} kcal consumed today.`);
            }


            async function loadNotionItems() {
                notionItemsDisplay.innerHTML = getSkeletonLoaderHtml(4); 
                notionItemsDisplay.classList.add('bg-gray-100'); 

                let sumTotalKcal = 0; 

                try {
                    const response = await fetch(NOTION_BACKEND_URL, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Backend (GET) error:', errorData);
                        throw new Error(`Error: ${errorData.message || errorData.error || 'Unknown backend error'}`);
                    }

                    const data = await response.json();
                    const items = data.items;

                    notionItemsDisplay.innerHTML = ''; 
                    notionItemsDisplay.classList.remove('bg-gray-100'); 

                    if (items.length === 0) {
                        notionItemsDisplay.innerHTML = `
                            <div class="text-center py-8">
                                <img src="https://cdn-icons-png.flaticon.com/512/7465/7465225.png" alt="Empty state icon" class="w-24 h-24 mx-auto mb-4 opacity-70">
                                <p class="text-gray-500 font-semibold text-lg">Nothing logged for today yet!</p>
                                <p class="text-gray-400 text-sm mt-1">Start by adding your first meal on the 'Add' tab.</p>
                            </div>
                        `;
                    } else {
                        items.forEach(item => {
                            sumTotalKcal += item.total; 
                            const descriptionPart = (item.name && item.name !== 'Untitled' && item.name !== 'Untitled Page' && item.name.trim() !== '') ? ` - ${item.name}` : '';

                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'py-2 flex justify-between items-center border-b border-gray-100 last:border-b-0 last:pb-0 text-base md:text-lg'; 
                            itemDiv.innerHTML = `
                                <div class="flex-1 overflow-hidden text-ellipsis pr-2 font-semibold">
                                    ${item.Type}${descriptionPart}
                                </div>
                                <div class="font-bold ${item.total < 0 ? 'text-red-500' : 'text-green-600'} flex items-center">
                                    ${item.total}
                                </div>
                            `;
                            notionItemsDisplay.appendChild(itemDiv);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load items from Notion:', error);
                    notionItemsDisplay.innerHTML = `<p class="text-center text-red-500">Failed to load items: ${error.message}</p>`;
                } finally {
                    updateKcalProgressBar(sumTotalKcal); 
                }
            }

            // --- Event Listeners ---
            sendBtn.addEventListener('click', function() {
                const category = hiddenCategoryInput.value;
                const description = descriptionInput.value;
                let kcal = kcalInput.value; 

                if (!category) {
                    messageArea.textContent = 'Please select a category.';
                    messageArea.style.color = '#dc2626';
                    return;
                }
                if (!kcal || isNaN(parseFloat(kcal))) { 
                    messageArea.textContent = 'Please enter a valid kcal value.';
                    messageArea.style.color = '#dc2626';
                    return;
                }

                kcal = parseInt(kcal, 10);

                sendToNotion({ category, description, kcal });
            });

            tabCategoryBtn.addEventListener('click', () => showTab('category'));
            tabTodayBtn.addEventListener('click', () => showTab('today'));

            // Initial load
            loadNotionItems();
            showTab('category'); 
            // Set initial random description placeholder for a default category (e.g., Breakfast)
            updateDescriptionPlaceholder("Breakfast");
        });
    </script>
</body>
</html>