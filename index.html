<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçõ Pantry-Pal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        @keyframes pulse-bg {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }
        .animate-pulse-bg {
          background: linear-gradient(to right, #f0f0f0 0%, #e0e0e0 20%, #f0f0f0 40%, #f0f0f0 100%);
          background-size: 200% 100%;
          animation: pulse-bg 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
    </style>
</head>
<body class="font-['Outfit'] bg-gradient-to-br from-purple-100 via-rose-100 to-amber-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm mx-auto bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 space-y-2">
        
        <div class="text-center">
            <div class="flex items-center justify-center mx-auto mb-2">
                <img src="https://cdn-icons-png.flaticon.com/512/2515/2515263.png" alt="Pantry-Pal Logo" class="w-16 h-16 mr-2">
                <h1 class="text-2xl font-bold text-gray-800">Pantry-Pal</h1>
            </div>
            <p class="text-gray-500 mt-1">What did we have today? ‚ú®</p>
        </div>

        <div class="flex border-b-2 border-gray-300 -mx-6 px-6 pt-2">
            <button id="tab-category" class="flex-1 py-2 px-3 text-center text-base font-bold rounded-t-xl cursor-pointer transition-colors duration-200 bg-indigo-500 text-white shadow-md">Add</button>
            <button id="tab-today" class="flex-1 py-2 px-3 text-center text-base font-bold rounded-t-xl cursor-pointer transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300">Today</button>
        </div>

        <div id="section-category" class="space-y-2 mt-4">
            <div>
                <div id="category-container" class="grid grid-cols-3 gap-3 mt-2">
                    <button class="border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-sky-200 bg-sky-100 text-sky-800 hover:border-sky-400" data-category="Breakfast">
                        <img src="https://cdn-icons-png.flaticon.com/512/9702/9702245.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Breakfast</span>
                    </button>
                    <button class="border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-violet-200 bg-violet-100 text-violet-800 hover:border-violet-400" data-category="Collagen">
                        <img src="https://cdn-icons-png.flaticon.com/512/11210/11210895.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Collagen</span>
                    </button>
                    <button class="border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-amber-200 bg-amber-100 text-amber-800 hover:border-amber-400" data-category="Coffee">
                        <img src="https://cdn-icons-png.flaticon.com/512/1448/1448438.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Coffee</span>
                    </button>
                    <button class="border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-lime-200 bg-lime-100 text-lime-800 hover:border-lime-400" data-category="Lunch">
                        <img src="https://cdn-icons-png.flaticon.com/512/2515/2515271.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Lunch</span>
                    </button>
                    <button class="border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-teal-200 bg-teal-100 text-teal-800 hover:border-teal-400" data-category="Exercise">
                        <img src="https://cdn-icons-png.flaticon.com/512/7681/7681038.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Exercise</span>
                    </button>
                    <button class="border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 ease-in-out border-slate-200 bg-slate-100 text-slate-800 hover:border-slate-400" data-category="Other">
                        <img src="https://cdn-icons-png.flaticon.com/512/7245/7245102.png" class="w-10 h-10 transition-transform duration-600 ease-in">
                        <span class="mt-1.5 text-xs font-medium">Other</span>
                    </button>
                </div>
                <input type="hidden" id="selected-category" name="category">
            </div>

            <div class="space-y-2">
                <div>
                    <input type="text" id="description" name="description" placeholder="Description (e.g., Avocado toast)" class="mt-1.5 p-3 block w-full border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-300 focus:border-rose-400 bg-white/70">
                </div>
                <div>
                    <input type="number" id="kcal" name="kcal" placeholder="Kcal (e.g., 350)" class="mt-1.5 p-3 block w-full border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-300 focus:border-rose-400 bg-white/70">
                </div>
            </div>
            
            <button id="send-btn" class="w-full flex items-center justify-center p-3 bg-rose-500 text-white text-lg font-bold rounded-xl shadow-md transition-all duration-200 ease-in-out transform scale-100 hover:bg-rose-600 active:bg-rose-700 active:scale-100">
                Send to Notion
                <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </button>
            
            <div id="message-area" class="text-center font-medium"></div>

            <div class="pt-4 mt-4 border-t border-gray-200">
                <div id="kcal-progress-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1500" class="w-full bg-gray-200 rounded-full h-3 relative overflow-hidden">
                    <div id="kcal-progress-fill" class="h-full bg-green-500 transition-all duration-500 ease-in-out" style="width: 0%;"></div>
                </div>
                <p id="kcal-progress-text" class="text-sm font-semibold text-gray-700 text-center mt-2">0 Kcal / 1500 Kcal</p>
            </div>
        </div>

        <div id="section-today" class="space-y-2 mt-4 hidden">
            <div id="notion-items-display" class="bg-gray-50 p-4 rounded-lg shadow-inner max-h-40 overflow-y-auto space-y-2 text-sm text-gray-700 mt-2">
                <p class="text-center text-gray-400">No items loaded yet.</p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const categoryContainer = document.getElementById('category-container');
            const hiddenCategoryInput = document.getElementById('selected-category');
            const descriptionInput = document.getElementById('description');
            const kcalInput = document.getElementById('kcal'); 
            const sendBtn = document.getElementById('send-btn');
            const messageArea = document.getElementById('message-area');

            const notionItemsDisplay = document.getElementById('notion-items-display');

            // Kcal Progress Bar Elements
            const kcalProgressBarContainer = document.getElementById('kcal-progress-bar-container');
            const kcalProgressFill = document.getElementById('kcal-progress-fill');
            const kcalProgressText = document.getElementById('kcal-progress-text');
            const KCAL_CAP = 1500; // Define the Kcal cap

            // Tab Elements
            const tabCategoryBtn = document.getElementById('tab-category');
            const tabTodayBtn = document.getElementById('tab-today');
            const sectionCategory = document.getElementById('section-category');
            const sectionToday = document.getElementById('section-today');

            // --- NOTION API ENDPOINT CONFIGURATION ---
            const NOTION_BACKEND_URL = '/api/pantryapi'; 

            // Define placeholder values for each category
            const kcalPlaceholders = {
                "Coffee": "50",
                "Breakfast": "311",
                "Lunch": "800",
                "Collagen": "40"
            };

            // --- Tab Switching Logic ---
            const tabBaseClasses = ['flex-1', 'py-2', 'px-3', 'text-center', 'text-base', 'font-bold', 'rounded-t-xl', 'cursor-pointer', 'transition-colors', 'duration-200'];
            const tabDefaultClasses = ['bg-gray-200', 'text-gray-700', 'hover:bg-gray-300'];
            const tabActiveClass = ['bg-indigo-500', 'text-white', 'shadow-md'];

            function setTabActiveState(button, isActive) {
                button.classList.remove(...tabDefaultClasses, ...tabActiveClass);
                if (isActive) {
                    button.classList.add(...tabActiveClass);
                } else {
                    button.classList.add(...tabDefaultClasses);
                }
            }

            function showTab(tabName) {
                setTabActiveState(tabCategoryBtn, false);
                setTabActiveState(tabTodayBtn, false);

                sectionCategory.classList.add('hidden');
                sectionToday.classList.add('hidden');

                if (tabName === 'category') {
                    setTabActiveState(tabCategoryBtn, true);
                    sectionCategory.classList.remove('hidden');
                } else if (tabName === 'today') {
                    setTabActiveState(tabTodayBtn, true);
                    sectionToday.classList.remove('hidden');
                }
                loadNotionItems(); // Always load/reload items when switching tabs, as data for both views comes from here
            }

            // --- Logic for Category Selection ---
            const categorySelectedClasses = ['border-indigo-500', 'bg-indigo-300', 'text-indigo-900', 'scale-105', 'shadow-lg'];
            const categorySelectedImgClasses = ['scale-125', 'transition-transform', 'duration-600', 'ease-out'];
            const categoryDefaultImgClasses = ['transition-transform', 'duration-600', 'ease-in'];

            categoryContainer.addEventListener('click', function(e) {
                const clickedButton = e.target.closest('button');
                if (!clickedButton || !clickedButton.dataset.category) return;

                const allButtons = categoryContainer.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.classList.remove(...categorySelectedClasses);
                    const img = btn.querySelector('img');
                    if (img) {
                        img.classList.remove('scale-125', 'ease-out');
                        img.classList.add('ease-in');
                    }
                });

                clickedButton.classList.add(...categorySelectedClasses);
                const clickedImg = clickedButton.querySelector('img');
                if (clickedImg) {
                    clickedImg.classList.add('scale-125', 'ease-out');
                    clickedImg.classList.remove('ease-in');
                }
                
                hiddenCategoryInput.value = clickedButton.dataset.category;

                const selectedCategory = hiddenCategoryInput.value;
                if (kcalPlaceholders[selectedCategory]) {
                    kcalInput.placeholder = `Kcal (e.g., ${kcalPlaceholders[selectedCategory]})`; // Update placeholder dynamically
                } else {
                    kcalInput.placeholder = "Kcal (e.g., 350)"; // Default placeholder
                }
            });

            // --- Function to send data to Notion via backend (POST request) ---
            async function sendToNotion(data) {
                messageArea.textContent = 'Sending to Notion...';
                messageArea.style.color = '#4f46e5';

                try {
                    const response = await fetch(NOTION_BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Backend (POST) error:', errorData);
                        throw new Error(`Error: ${errorData.message || errorData.error || 'Unknown backend error'}`);
                    }

                    const result = await response.json();
                    console.log('Successfully sent to Notion via backend:', result);
                    messageArea.textContent = 'Sent to Notion! ‚ú®';
                    messageArea.style.color = '#16a34a';
                    loadNotionItems(); // Refresh data after sending
                } catch (error) {
                    console.error('Failed to send to Notion:', error);
                    messageArea.textContent = `Error: ${error.message || 'Network error'}`;
                    messageArea.style.color = '#dc2626';
                } finally {
                    setTimeout(() => {
                        messageArea.textContent = '';
                        hiddenCategoryInput.value = '';
                        descriptionInput.value = '';
                        kcalInput.value = ''; 
                        kcalInput.placeholder = "Kcal (e.g., 350)"; // Reset to default placeholder
                        const allButtons = categoryContainer.querySelectorAll('button');
                        allButtons.forEach(btn => {
                            btn.classList.remove(...categorySelectedClasses);
                            const img = btn.querySelector('img');
                            if (img) {
                                img.classList.remove('scale-125', 'ease-out');
                                img.classList.add('ease-in'); 
                            }
                        });
                    }, 2000);
                }
            }

            // Function to generate skeleton loader HTML
            function getSkeletonLoaderHtml(count = 3) {
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="h-6 bg-gray-200 rounded w-full mb-2 animate-pulse-bg"></div>
                    `;
                }
                return html;
            }

            // --- Function to update the Kcal progress bar ---
            function updateKcalProgressBar(currentKcalSum) {
                const percentage = Math.min(100, (currentKcalSum / KCAL_CAP) * 100);
                
                kcalProgressFill.style.width = `${percentage}%`;
                
                let emoji = '';
                if (currentKcalSum <= KCAL_CAP) {
                    emoji = '‚ú® '; // Encouraging emoji when below or at target
                } else {
                    emoji = ''; // No emoji when over target
                }
                kcalProgressText.textContent = `${emoji}${currentKcalSum} Kcal / ${KCAL_CAP} Kcal`;

                // Update colors based on progress
                if (currentKcalSum > KCAL_CAP) {
                    kcalProgressFill.classList.remove('bg-green-500', 'bg-yellow-500');
                    kcalProgressFill.classList.add('bg-red-500'); // Over cap, turn red
                    kcalProgressText.classList.remove('text-gray-700', 'text-amber-600');
                    kcalProgressText.classList.add('text-red-600');
                } else if (percentage >= 80) { // Nearing cap, turn yellow
                    kcalProgressFill.classList.remove('bg-green-500', 'bg-red-500');
                    kcalProgressFill.classList.add('bg-yellow-500');
                    kcalProgressText.classList.remove('text-gray-700', 'text-red-600');
                    kcalProgressText.classList.add('text-amber-600');
                } else {
                    kcalProgressFill.classList.remove('bg-red-500', 'bg-yellow-500');
                    kcalProgressFill.classList.add('bg-green-500'); // Normal range, turn green
                    kcalProgressText.classList.remove('text-red-600', 'text-amber-600');
                    kcalProgressText.classList.add('text-gray-700');
                }

                // Update ARIA attributes for accessibility
                kcalProgressBarContainer.setAttribute('aria-valuenow', currentKcalSum);
                kcalProgressBarContainer.setAttribute('aria-valuetext', `${currentKcalSum} out of ${KCAL_CAP} Kcal consumed today.`);
            }


            // --- Function to load data from Notion via backend (GET request) ---
            async function loadNotionItems() {
                // Display skeleton loader effect
                notionItemsDisplay.innerHTML = getSkeletonLoaderHtml(4); // Show 4 loading lines
                notionItemsDisplay.classList.add('bg-gray-100'); // Add a base background for the loader container

                let sumTotalKcal = 0; // Initialize sum for the progress bar

                try {
                    const response = await fetch(NOTION_BACKEND_URL, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Backend (GET) error:', errorData);
                        throw new Error(`Error: ${errorData.message || errorData.error || 'Unknown backend error'}`);
                    }

                    const data = await response.json();
                    const items = data.items;

                    // Clear skeleton loader
                    notionItemsDisplay.innerHTML = ''; 
                    notionItemsDisplay.classList.remove('bg-gray-100'); // Remove base loading background

                    if (items.length === 0) {
                        notionItemsDisplay.innerHTML = '<p class="text-center text-gray-400">No items found for today\'s view.</p>';
                    } else {
                        items.forEach(item => {
                            sumTotalKcal += item.total; // Summing up Kcal for the progress bar
                            // Exclude "Untitled Page" and "Untitled" from description
                            const descriptionPart = (item.name && item.name !== 'Untitled' && item.name !== 'Untitled Page' && item.name !== ' ') ? ` - ${item.name}` : '';

                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'py-2 flex justify-between items-center border-b border-gray-100 last:border-b-0 last:pb-0';
                            itemDiv.innerHTML = `
                                <div class="flex-1 overflow-hidden whitespace-nowrap text-ellipsis pr-2">
                                    <p class="font-semibold text-gray-600 text-sm">${item.Type}${descriptionPart}</p>
                                </div>
                                <div class="font-bold text-gray-600 flex-shrink-0 text-sm">
                                    <p>${item.total} Kcal</p>
                                </div>
                            `;
                            notionItemsDisplay.appendChild(itemDiv);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load items from Notion:', error);
                    // Clear skeleton and show error message
                    notionItemsDisplay.innerHTML = `<p class="text-center text-red-600">Failed to load items: ${error.message || 'Check console.'}</p>`;
                    notionItemsDisplay.classList.remove('bg-gray-100'); // Ensure background is removed
                    sumTotalKcal = 0; // Reset sum on error
                } finally {
                    // Always update the progress bar, even on error or empty data
                    updateKcalProgressBar(sumTotalKcal);
                }
            }


            // --- Event Listeners ---
            sendBtn.addEventListener('click', async function() {
                const category = hiddenCategoryInput.value;
                const description = descriptionInput.value;
                const kcal = kcalInput.value; 

                if (!category) {
                    messageArea.textContent = 'Please select a category!';
                    messageArea.style.color = '#dc2626';
                    return;
                }
                if (!kcal || isNaN(parseInt(kcal, 10))) {
                    messageArea.textContent = 'Please enter a valid kcal amount!';
                    messageArea.style.color = '#dc2626';
                    return;
                }

                const dataToSend = {
                    category: category,
                    description: description || '',
                    kcal: parseInt(kcal, 10)
                };
                
                await sendToNotion(dataToSend);
            });

            // Tab Button Event Listeners
            tabCategoryBtn.addEventListener('click', () => showTab('category'));
            tabTodayBtn.addEventListener('click', () => showTab('today'));

            // Initial tab selection and data load
            showTab('category'); // This will set the initial tab and trigger loadNotionItems
        });
    </script>

</body>
</html>